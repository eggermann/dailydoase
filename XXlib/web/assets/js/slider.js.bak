import animateScrollTo from 'animated-scroll-to';

const slider = {
    timeout: 5000, // 5 seconds per slide
    sliderId: 0,
    slidePos: 0,
    sortedEls: null,
    lastEl: null,
    contentEl: null,
    panelElement: null,
    toggleView: null,

    showImg: (index) => {
        let ind = index;

        const menuEl = document.querySelector('.c-aside__menu [aria-current]');
        const cntrEl = document.querySelector('.c-aside__menu [aria-current] ~.image-cntr');

        const step = () => {
            if (ind >= slider.sortedEls.length) {
                // Reset to beginning
                ind = 0;
                slider.slidePos = 0;
            }

            const nextEl = slider.sortedEls[ind];
            nextEl.classList.add('active');
            nextEl.classList.remove('display-none');
            animateScrollTo(nextEl, {speed: 0});

            if (slider.lastEl) {
                slider.lastEl.classList.remove('active');
            }

            if (slider.contentEl) {
                slider.contentEl.innerText = nextEl.getAttribute('title');
            }

            const len = Object.keys(slider.sortedEls).length;
            if (cntrEl) {
                cntrEl.innerText = len + '/' + (len - index);
            }

            slider.lastEl = nextEl;
        };
        
        window.requestAnimationFrame(step);
    },

    startSlider: () => {
        if (slider.toggleView && slider.toggleView.checked) {
            slider.toggleView.click();
        }

        if (slider.panelElement) {
            slider.panelElement.classList.add('playing');
        }
        document.body.classList.add('playing');
        
        slider.showImg(slider.slidePos++);

        const nextSlide = () => {
            slider.sliderId = setTimeout(() => {
                slider.showImg(slider.slidePos++);
                nextSlide();
            }, slider.timeout);
        };

        nextSlide();
    },

    stopSlider: () => {
        clearTimeout(slider.sliderId);
        if (slider.panelElement) {
            slider.panelElement.classList.remove('playing');
        }
        document.body.classList.remove('playing');
    }
};

export default {
    init() {
        const sliderBtn = document.querySelector('#sliderStart');
        if (!sliderBtn) return;

        slider.panelElement = document.querySelector('.c-panel');
        slider.contentEl = document.querySelector('.c-panel__content__info');
        slider.toggleView = document.querySelector('#toggleView');

        const els = document.querySelectorAll('[data-mtime]');
        els.forEach(el => {
            el.addEventListener('transitionend', function(e) {
                if (!e.target.classList.contains('active')) {
                    e.target.classList.add('display-none');
                }
            });

            el.classList.add('display-none');
        });

        slider.sortedEls = [...els].sort((a, b) => {
            return parseFloat(b.dataset.mtime) - parseFloat(a.dataset.mtime);
        });

        sliderBtn.addEventListener('click', () => {
            if (!sliderBtn.checked) {
                slider.startSlider();
                sliderBtn.setAttribute('checked', 'true');
            } else {
                slider.stopSlider();
                sliderBtn.removeAttribute('checked');
            }
        });
    }
};